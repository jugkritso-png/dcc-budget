generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Category {
  id             String        @id @default(uuid())
  name           String
  code           String
  segment        String
  allocated      Float
  used           Float         @default(0)
  color          String
  colorLabel     String
  year           Int
  businessPlace  String?
  businessArea   String?
  fund           String?
  fundCenter     String?
  costCenter     String?
  functionalArea String?
  commitmentItem String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  logs           BudgetLog[]
  expenses       Expense[]
  subActivities  SubActivity[]
}

model Expense {
  id          String   @id @default(uuid())
  categoryId  String
  amount      Float
  payee       String
  date        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
}

model SubActivity {
  id         String          @id @default(uuid())
  categoryId String
  name       String
  allocated  Float
  parentId   String?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  plans      BudgetPlan[]
  requests   BudgetRequest[]
  parent     SubActivity?    @relation("SubActivityToSubActivity", fields: [parentId], references: [id])
  children   SubActivity[]   @relation("SubActivityToSubActivity")
  category   Category        @relation(fields: [categoryId], references: [id])
}

model BudgetPlan {
  id            String      @id @default(uuid())
  subActivityId String
  year          Int
  month         Int
  amount        Float
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  subActivity   SubActivity @relation(fields: [subActivityId], references: [id], onDelete: Cascade)

  @@unique([subActivityId, year, month])
}

model Department {
  id        String   @id @default(uuid())
  name      String
  code      String
  color     String   @default("#3B82F6")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BudgetRequest {
  id              String              @id @default(uuid())
  project         String
  category        String
  activity        String?
  subActivityId   String?
  amount          Float
  date            String
  status          String              @default("pending")
  requester       String
  notes           String?
  department      String?
  approvalRef     String?
  urgency         String?             @default("normal")
  startDate       String?
  endDate         String?
  reason          String?
  approverId      String?
  approvedAt      DateTime?
  rejectionReason String?
  actualAmount    Float?              @default(0)
  returnAmount    Float?              @default(0)
  completedAt     DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  subActivity     SubActivity?        @relation(fields: [subActivityId], references: [id])
  expenseItems    BudgetRequestItem[]
}

model BudgetRequestItem {
  id           String        @id @default(uuid())
  requestId    String
  category     String
  description  String
  quantity     Float
  unit         String
  unitPrice    Float
  total        Float
  actualAmount Float?        @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  request      BudgetRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
}

model BudgetLog {
  id         String   @id @default(uuid())
  categoryId String
  amount     Float
  type       String
  reason     String
  user       String?
  createdAt  DateTime @default(now())
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
}

model SystemSetting {
  key   String @id
  value String
}

model User {
  id           String        @id @default(uuid())
  username     String        @unique
  password     String
  name         String
  email        String        @unique
  role         String        @default("user")
  googleId     String?       @unique
  position     String?
  department   String?
  phone        String?
  employeeId   String?
  bio          String?
  avatar       String?
  englishName  String?
  startDate    String?
  theme        String?       @default("light")
  language     String?       @default("th")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  activityLogs ActivityLog[]
}

model ActivityLog {
  id         String   @id @default(uuid())
  userId     String?
  action     String
  entityId   String?
  entityType String?
  details    String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])
}
